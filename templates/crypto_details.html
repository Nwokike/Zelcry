{% extends 'base.html' %}
{% load static %}

{% block title %}{{ crypto.name }} - Zelcry{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold">{{ crypto.name }} ({{ crypto.symbol|upper }})</h2>
            <p class="text-muted mb-0">{{ crypto.description }}</p>
        </div>
        <div class="text-end">
            <div class="h3 fw-bold">${{ current_price|floatformat:2 }}</div>
            <div class="{% if price_change_24h >= 0 %}price-up{% else %}price-down{% endif %}">
                {% if price_change_24h >= 0 %}▲{% else %}▼{% endif %} {{ price_change_24h|floatformat:2 }}%
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <small class="text-muted">Market Cap</small>
                    <div class="fw-bold">${{ market_cap|floatformat:0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <small class="text-muted">24h Volume</small>
                    <div class="fw-bold">${{ volume_24h|floatformat:0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <small class="text-muted">Impact Score</small>
                    <div class="impact-score {% if crypto.get_impact_score >= 7 %}impact-high{% elif crypto.get_impact_score >= 4 %}impact-medium{% else %}impact-low{% endif %}">
                        {{ crypto.get_impact_score }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    {% if user.is_authenticated %}
                    <button class="btn btn-primary w-100" onclick="addToPortfolio()">
                        <i class="bi bi-plus-circle me-2"></i>Add to Portfolio
                    </button>
                    <button class="btn btn-outline-warning w-100 mt-2" onclick="addToWatchlist()">
                        <i class="bi bi-star me-2"></i>Add to Watchlist
                    </button>
                    {% else %}
                    <a href="{% url 'login' %}" class="btn btn-primary w-100">Login to Track</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0 fw-bold">Price Chart (30 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="priceChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0 fw-bold">Sustainability Scores</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-semibold">Energy Efficiency</span>
                            <span class="badge {% if crypto.energy_score >= 7 %}bg-success{% elif crypto.energy_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ crypto.energy_score }}/10
                            </span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if crypto.energy_score >= 7 %}bg-success{% elif crypto.energy_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ crypto.energy_score }}0%"></div>
                        </div>
                        <small class="text-muted">{{ energy_explanation }}</small>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-semibold">Governance</span>
                            <span class="badge {% if crypto.governance_score >= 7 %}bg-success{% elif crypto.governance_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ crypto.governance_score }}/10
                            </span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if crypto.governance_score >= 7 %}bg-success{% elif crypto.governance_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ crypto.governance_score }}0%"></div>
                        </div>
                        <small class="text-muted">{{ governance_explanation }}</small>
                    </div>

                    <div class="mb-0">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-semibold">Utility</span>
                            <span class="badge {% if crypto.utility_score >= 7 %}bg-success{% elif crypto.utility_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ crypto.utility_score }}/10
                            </span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if crypto.utility_score >= 7 %}bg-success{% elif crypto.utility_score >= 4 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ crypto.utility_score }}0%"></div>
                        </div>
                        <small class="text-muted">{{ utility_explanation }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="addToPortfolioForm" method="post" action="{% url 'add_to_portfolio' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="coin_id" value="{{ crypto.coin_id }}">
    <input type="hidden" name="coin_name" value="{{ crypto.name }}">
    <input type="hidden" name="coin_symbol" value="{{ crypto.symbol }}">
    <input type="hidden" name="purchase_price" value="{{ current_price }}">
    <input type="hidden" name="quantity" id="portfolio_quantity">
</form>

<form id="addToWatchlistForm" method="post" action="{% url 'watchlist' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="coin_id" value="{{ crypto.coin_id }}">
    <input type="hidden" name="coin_name" value="{{ crypto.name }}">
    <input type="hidden" name="coin_symbol" value="{{ crypto.symbol }}">
</form>
{% endblock %}

{% block extra_js %}
<script>
const chartData = {{ chart_data|safe }};
const ctx = document.getElementById('priceChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: '{{ crypto.name }} Price (USD)',
            data: chartData.prices,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

function addToPortfolio() {
    const quantity = prompt('Enter quantity to add to portfolio:');
    if (quantity && parseFloat(quantity) > 0) {
        document.getElementById('portfolio_quantity').value = quantity;
        document.getElementById('addToPortfolioForm').submit();
    }
}

function addToWatchlist() {
    document.getElementById('addToWatchlistForm').submit();
}
</script>
{% endblock %}
