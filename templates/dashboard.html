{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Zelcry{% endblock %}

{% block extra_css %}
<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    animation: fadeIn 0.3s;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.modal-content {
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #00d4ff;
    width: 90%;
    max-width: 600px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3);
    animation: slideDown 0.3s;
}
@keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.close {
    color: #00d4ff;
    float: right;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s;
}
.close:hover { transform: rotate(90deg); }
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.stat-card {
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #333;
    transition: transform 0.3s, box-shadow 0.3s;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0, 212, 255, 0.2);
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(135deg, #00d4ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-label {
    color: #999;
    font-size: 0.9rem;
    margin-top: 5px;
}
.level-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #00d4ff, #00ff88);
    border-radius: 25px;
    color: #0a0a0a;
    font-weight: bold;
    font-size: 1.1rem;
}
.xp-bar {
    width: 100%;
    height: 20px;
    background: #0a0a0a;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}
.xp-progress {
    height: 100%;
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    transition: width 1s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0a0a0a;
    font-weight: bold;
    font-size: 0.8rem;
}
.trending-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.trending-card {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #333;
}
.coin-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 600;
    margin: 2px;
}
.badge-sustainable { background: #00ff8840; color: #00ff88; border: 1px solid #00ff88; }
.badge-high-growth { background: #00d4ff40; color: #00d4ff; border: 1px solid #00d4ff; }
.badge-stable { background: #ffa50040; color: #ffa500; border: 1px solid #ffa500; }
.tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
    border-bottom: 1px dotted #00d4ff;
}
.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: #1a1a1a;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 10px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    border: 1px solid #00d4ff;
    font-size: 0.85rem;
}
.tooltip:hover .tooltiptext {
    visibility: visible;
    animation: fadeIn 0.3s;
}
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #333;
    border-top: 3px solid #00d4ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Welcome, {{ user.username }}! {{ badge }}</h1>
        <div class="level-badge">
            Level {{ level_num }}: {{ level_name }}
        </div>
        <div class="xp-bar">
            <div class="xp-progress" style="width: {{ progress_to_next }}%;">
                {{ user.profile.xp_points }} XP
            </div>
        </div>
        <p style="color: #999; font-size: 0.9rem;">{{ progress_to_next|floatformat:0 }}% to next level | Risk Tolerance: {{ user.profile.risk_tolerance }}</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">${{ total_portfolio_value|floatformat:2 }}</div>
            <div class="stat-label">
                <span class="tooltip">Total Portfolio Value
                    <span class="tooltiptext">Current market value of all your crypto holdings</span>
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: {% if total_profit_loss >= 0 %}#00ff88{% else %}#ff4444{% endif %}">
                {% if total_profit_loss >= 0 %}+{% endif %}${{ total_profit_loss|floatformat:2 }}
            </div>
            <div class="stat-label">
                <span class="tooltip">Profit/Loss
                    <span class="tooltiptext">Total gains or losses compared to your initial investment</span>
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: {% if total_roi >= 0 %}#00ff88{% else %}#ff4444{% endif %}">
                {% if total_roi >= 0 %}+{% endif %}{{ total_roi|floatformat:2 }}%
            </div>
            <div class="stat-label">
                <span class="tooltip">ROI
                    <span class="tooltiptext">Return on Investment - percentage gain/loss</span>
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ num_coins }}</div>
            <div class="stat-label">Coins Held</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ diversification_score|floatformat:1 }}/10</div>
            <div class="stat-label">
                <span class="tooltip">Diversification Score
                    <span class="tooltiptext">How well-spread your investments are. Aim for 8+!</span>
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ sustainability_score|floatformat:1 }}/10</div>
            <div class="stat-label">
                <span class="tooltip">Sustainability Score
                    <span class="tooltiptext">How eco-friendly your portfolio is. Higher is better!</span>
                </span>
            </div>
        </div>
    </div>

    <div class="trending-section">
        <div class="trending-card">
            <h3>🚀 Top Gainers (24h)</h3>
            {% for coin in trending_coins|slice:":5" %}
            <div style="margin: 10px 0; padding: 10px; background: #0a0a0a; border-radius: 8px;">
                <strong>{{ coin.name }}</strong> ({{ coin.symbol|upper }})<br>
                <span class="positive" style="font-size: 1.2rem;">+{{ coin.price_change_percentage_24h|floatformat:2 }}%</span>
                <span style="color: #999;"> - ${{ coin.current_price|floatformat:2 }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="trending-card">
            <h3>🌱 Top Sustainable Coins</h3>
            {% for crypto in sustainable_cryptos %}
            <div style="margin: 10px 0; padding: 10px; background: #0a0a0a; border-radius: 8px;">
                <strong>{{ crypto.name }}</strong> ({{ crypto.symbol|upper }})<br>
                <span style="color: #00ff88; font-size: 1.2rem;">⚡ {{ crypto.energy_score }}/10 Energy</span><br>
                <span style="color: #999; font-size: 0.85rem;">{{ crypto.description|slice:":80" }}...</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="chart-section">
        <h2>📈 Bitcoin 30-Day Price Chart</h2>
        <canvas id="bitcoinChart" width="400" height="200"></canvas>
    </div>

    <div class="portfolio-section">
        <h2>💼 My Portfolio</h2>
        {% if portfolio_assets %}
        <div class="portfolio-table-wrapper">
            <table class="portfolio-table">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Quantity</th>
                        <th>Avg Buy Price</th>
                        <th>Current Price</th>
                        <th>Total Value</th>
                        <th>Profit/Loss</th>
                        <th>ROI %</th>
                        <th>24h %</th>
                        <th>Impact</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio_assets %}
                    <tr>
                        <td>
                            <a href="{% url 'crypto_details' asset.coin_id %}">
                                {{ asset.coin_name }} ({{ asset.coin_symbol|upper }})
                            </a>
                        </td>
                        <td>{{ asset.quantity }}</td>
                        <td>${{ asset.purchase_price|floatformat:2 }}</td>
                        <td>${{ asset.current_price|floatformat:2 }}</td>
                        <td><strong>${{ asset.total_value|floatformat:2 }}</strong></td>
                        <td class="{% if asset.profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                            {% if asset.profit_loss >= 0 %}+{% endif %}${{ asset.profit_loss|floatformat:2 }}
                        </td>
                        <td class="{% if asset.roi >= 0 %}positive{% else %}negative{% endif %}">
                            {% if asset.roi >= 0 %}+{% endif %}{{ asset.roi|floatformat:2 }}%
                        </td>
                        <td class="{% if asset.price_change_24h >= 0 %}positive{% else %}negative{% endif %}">
                            {{ asset.price_change_24h|floatformat:2 }}%
                        </td>
                        <td>
                            {% if asset.impact_score %}
                            <div class="circular-progress" data-score="{{ asset.impact_score }}">
                                <span>{{ asset.impact_score }}</span>
                            </div>
                            {% if asset.impact_score >= 7 %}
                                <span class="coin-badge badge-sustainable">🌱 Eco</span>
                            {% endif %}
                            {% else %}
                            <span style="color: #666;">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); border-radius: 12px; border: 1px solid #333;">
            <h3>💡 Portfolio Insights</h3>
            {% if diversification_score < 5 %}
                <p style="color: #ffa500;">⚠️ Your portfolio could use more diversification! Consider adding 3-5 more coins from different categories.</p>
            {% elif diversification_score < 8 %}
                <p style="color: #00d4ff;">👍 Good diversification! Adding a few more coins would optimize your risk spread.</p>
            {% else %}
                <p style="color: #00ff88;">🌟 Excellent diversification! Your portfolio is well-balanced across multiple assets.</p>
            {% endif %}
            
            {% if sustainability_score < 5 %}
                <p style="color: #ffa500;">🌍 Tip: Consider adding more sustainable cryptocurrencies like Algorand, Cardano, or Stellar to reduce your environmental impact!</p>
            {% elif sustainability_score < 7 %}
                <p style="color: #00d4ff;">🌱 Your portfolio has decent sustainability! Adding more eco-friendly coins would boost your green score.</p>
            {% else %}
                <p style="color: #00ff88;">♻️ Amazing! Your portfolio is highly sustainable. You're making a positive environmental impact!</p>
            {% endif %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: #1a1a1a; border-radius: 12px; border: 1px solid #333;">
            <p style="font-size: 1.2rem; color: #999;">📊 No assets in your portfolio yet!</p>
            <p style="color: #666;">Start by adding sustainable cryptocurrencies from the market below.</p>
            <p style="color: #00d4ff; font-weight: 600;">💡 Tip: Diversify across 5-10 coins for best results!</p>
        </div>
        {% endif %}
    </div>

    <div class="market-section">
        <h2>🌐 Cryptocurrency Market</h2>
        <input type="text" id="searchInput" placeholder="🔍 Search cryptocurrencies by name or symbol..." class="search-input">
        <div class="market-table-wrapper">
            <table class="market-table" id="marketTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Coin</th>
                        <th>Price</th>
                        <th>24h %</th>
                        <th>Market Cap</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="marketTableBody">
                    {% for coin in top_coins %}
                    <tr>
                        <td>{{ coin.market_cap_rank }}</td>
                        <td>
                            {{ coin.name }} ({{ coin.symbol|upper }})
                            {% if coin.market_cap_rank <= 10 %}
                                <span class="coin-badge badge-stable">Top 10</span>
                            {% endif %}
                        </td>
                        <td>${{ coin.current_price|floatformat:2 }}</td>
                        <td class="{% if coin.price_change_percentage_24h >= 0 %}positive{% else %}negative{% endif %}">
                            {{ coin.price_change_percentage_24h|floatformat:2 }}%
                        </td>
                        <td>${{ coin.market_cap|floatformat:0 }}</td>
                        <td>
                            <button class="btn-add" onclick="openAddModal('{{ coin.id }}', '{{ coin.name }}', '{{ coin.symbol }}', {{ coin.current_price }})">+ Add</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h2>Add to Your Portfolio</h2>
        <form method="post" action="{% url 'add_to_portfolio' %}" id="addForm">
            {% csrf_token %}
            <input type="hidden" name="coin_id" id="modalCoinId">
            <input type="hidden" name="coin_name" id="modalCoinName">
            <input type="hidden" name="coin_symbol" id="modalCoinSymbol">
            <input type="hidden" name="purchase_price" id="modalPurchasePrice">
            <div class="form-group">
                <label style="font-size: 1.1rem; color: #00d4ff;">Coin: <span id="modalCoinDisplay"></span></label>
            </div>
            <div class="form-group">
                <label>Current Price: <span style="font-size: 1.2rem; color: #00ff88;">$<span id="modalPriceDisplay"></span></span></label>
            </div>
            <div class="form-group">
                <label for="quantity">Quantity <span style="color: #999;">(How many coins?)</span></label>
                <input type="number" name="quantity" id="quantity" step="0.00000001" min="0.00000001" required style="font-size: 1.1rem;">
            </div>
            <div style="margin: 15px 0; padding: 15px; background: #0a0a0a; border-radius: 8px; border: 1px solid #333;">
                <p style="color: #00d4ff; font-weight: 600;">💰 Investment Estimate</p>
                <p style="color: #999; font-size: 0.9rem;">Enter quantity to see total investment</p>
                <p id="investmentCalc" style="font-size: 1.3rem; color: #00ff88; font-weight: bold;">$0.00</p>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                Add to Portfolio (+25 XP) 🎉
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const bitcoinData = {{ bitcoin_chart_data|safe }};

const ctx = document.getElementById('bitcoinChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: bitcoinData.labels,
        datasets: [{
            label: 'Bitcoin Price (USD)',
            data: bitcoinData.prices,
            borderColor: '#f7931a',
            backgroundColor: 'rgba(247, 147, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                labels: { color: '#fff', font: { size: 14 } }
            },
            tooltip: {
                backgroundColor: '#1a1a1a',
                titleColor: '#00d4ff',
                bodyColor: '#fff',
                borderColor: '#00d4ff',
                borderWidth: 1,
                padding: 12,
                displayColors: false
            }
        },
        scales: {
            y: {
                ticks: { color: '#fff', font: { size: 12 } },
                grid: { color: '#333' }
            },
            x: {
                ticks: { color: '#fff', font: { size: 12 } },
                grid: { color: '#333' }
            }
        }
    }
});

document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#marketTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});

let currentPrice = 0;

function openAddModal(coinId, coinName, coinSymbol, price) {
    document.getElementById('modalCoinId').value = coinId;
    document.getElementById('modalCoinName').value = coinName;
    document.getElementById('modalCoinSymbol').value = coinSymbol;
    document.getElementById('modalPurchasePrice').value = price;
    document.getElementById('modalCoinDisplay').textContent = coinName + ' (' + coinSymbol.toUpperCase() + ')';
    document.getElementById('modalPriceDisplay').textContent = price.toFixed(2);
    document.getElementById('addModal').style.display = 'block';
    document.getElementById('quantity').value = '';
    document.getElementById('investmentCalc').textContent = '$0.00';
    currentPrice = price;
}

function closeAddModal() {
    document.getElementById('addModal').style.display = 'none';
}

document.getElementById('quantity').addEventListener('input', function() {
    const quantity = parseFloat(this.value) || 0;
    const total = quantity * currentPrice;
    document.getElementById('investmentCalc').textContent = '$' + total.toFixed(2);
});

window.onclick = function(event) {
    const modal = document.getElementById('addModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

document.querySelectorAll('.circular-progress').forEach(circle => {
    const score = circle.getAttribute('data-score');
    circle.style.setProperty('--score', score);
});
</script>
{% endblock %}
